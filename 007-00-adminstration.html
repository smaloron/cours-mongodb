<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-02-23T18:21:36.480436"><title>Administration | mongodb</title><script type="application/json" id="virtual-toc-data">[{"id":"r-plicaction","level":0,"title":"RÃ©plicaction","anchor":"#r-plicaction"},{"id":"sharding","level":0,"title":"Sharding","anchor":"#sharding"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Administration | mongodb"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="mongodb Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/007-00-adminstration.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Administration | mongodb"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/007-00-adminstration.html#webpage",
    "url": "writerside-documentation/007-00-adminstration.html",
    "name": "Administration | mongodb",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "mongodb Help"
}</script><!-- End Schema.org --></head><body data-id="007-00-Adminstration" data-main-title="Administration" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs=""><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>mongodb  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="007-00-Adminstration" id="007-00-Adminstration.md">Administration</h1><section class="chapter"><h2 id="r-plicaction" data-toc="r-plicaction">R&eacute;plicaction</h2><p id="z8kqkkm_5">Un Replica Set dans MongoDB est un groupe d'instances MongoDB qui maintiennent les m&ecirc;mes donn&eacute;es pour assurer la haute disponibilit&eacute; et la redondance. Il est compos&eacute; de plusieurs n&oelig;uds (serveurs), dont au moins un est un n&oelig;ud primaire et les autres sont des n&oelig;uds secondaires.</p><section class="chapter"><h3 id="composition-d-un-replica-set" data-toc="composition-d-un-replica-set">Composition d'un replica set</h3><ol class="list _decimal" id="z8kqkkm_11" type="1"><li class="list__item" id="z8kqkkm_12"><p id="z8kqkkm_15">Un n&oelig;ud primaire (Primary)</p><ul class="list _bullet" id="z8kqkkm_16"><li class="list__item" id="z8kqkkm_17"><p>C'est le serveur principal qui re&ccedil;oit toutes les op&eacute;rations d'&eacute;criture et de lecture (sauf si la lecture secondaire est activ&eacute;e).</p></li><li class="list__item" id="z8kqkkm_18"><p>Il synchronise automatiquement ses donn&eacute;es avec les n&oelig;uds secondaires.</p></li><li class="list__item" id="z8kqkkm_19"><p>Un seul n&oelig;ud primaire peut exister &agrave; un instant donn&eacute;.</p></li></ul></li><li class="list__item" id="z8kqkkm_13"><p id="z8kqkkm_20">Un ou plusieurs n&oelig;uds secondaires (Secondary)</p><ul class="list _bullet" id="z8kqkkm_21"><li class="list__item" id="z8kqkkm_22"><p>Ces n&oelig;uds r&eacute;pliquent les donn&eacute;es du n&oelig;ud primaire en lisant son oplog (journal des op&eacute;rations).</p></li><li class="list__item" id="z8kqkkm_23"><p>Ils servent principalement pour la redondance et la tol&eacute;rance aux pannes.</p></li><li class="list__item" id="z8kqkkm_24"><p>Ils peuvent &ecirc;tre configur&eacute;s pour r&eacute;pondre aux requ&ecirc;tes en lecture si besoin.</p></li></ul></li><li class="list__item" id="z8kqkkm_14"><p id="z8kqkkm_25">(Optionnel) Un n&oelig;ud arbitre (Arbiter)</p><ul class="list _bullet" id="z8kqkkm_26"><li class="list__item" id="z8kqkkm_27"><p>Il ne stocke pas de donn&eacute;es mais participe au processus d'&eacute;lection en cas de panne du n&oelig;ud primaire.</p></li><li class="list__item" id="z8kqkkm_28"><p>Il est utile pour &eacute;viter une configuration avec un nombre pair de n&oelig;uds, ce qui permet d'&eacute;viter des conflits lors des &eacute;lections.</p></li></ul></li></ol></section><section class="chapter"><h3 id="fonctionnement-d-un-replica-set" data-toc="fonctionnement-d-un-replica-set">Fonctionnement d'un Replica Set</h3><ol class="list _decimal" id="z8kqkkm_29" type="1"><li class="list__item" id="z8kqkkm_30"><p>Lorsqu'une requ&ecirc;te d'&eacute;criture arrive, elle est trait&eacute;e par le n&oelig;ud primaire.</p></li><li class="list__item" id="z8kqkkm_31"><p>Les n&oelig;uds secondaires r&eacute;pliquent les modifications en copiant l'oplog du primaire. La r&eacute;plication est asynchrone, mais g&eacute;n&eacute;ralement assez rapide.</p></li><li class="list__item" id="z8kqkkm_32"><p>Si le n&oelig;ud primaire tombe en panne, un vote d'&eacute;lection est d&eacute;clench&eacute; entre les secondaires et un nouveau n&oelig;ud primaire est &eacute;lu automatiquement.</p></li><li class="list__item" id="z8kqkkm_33"><p>Une fois le n&oelig;ud d&eacute;faillant r&eacute;par&eacute;, il peut r&eacute;int&eacute;grer le Replica Set en tant que n&oelig;ud secondaire.</p></li></ol></section><section class="chapter"><h3 id="un-exemple-avec-docker" data-toc="un-exemple-avec-docker">Un exemple avec Docker</h3><div class="code-block" data-lang="yaml">
# docker-compose.yml

services:
  mongo1:
    image: mongo:latest
    container_name: mongo1
    restart: always
    command: [&quot;mongod&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--bind_ip&quot;, &quot;0.0.0.0&quot;]
    ports:
      - &quot;27020:27017&quot;
    networks:
      - mongo-network
    volumes:
      - mongo1_data:/data/db

  mongo2:
    image: mongo:latest
    container_name: mongo2
    restart: always
    command: [&quot;mongod&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--bind_ip&quot;, &quot;0.0.0.0&quot;]
    ports:
      - &quot;27021:27017&quot;
    networks:
      - mongo-network
    volumes:
      - mongo2_data:/data/db

  mongo3:
    image: mongo:latest
    container_name: mongo3
    restart: always
    command: [&quot;mongod&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--bind_ip&quot;, &quot;0.0.0.0&quot;]
    ports:
      - &quot;27022:27017&quot;
    networks:
      - mongo-network
    volumes:
      - mongo3_data:/data/db

  mongo-arbiter:
    image: mongo:latest
    container_name: mongo-arbiter
    restart: always
    command: [&quot;mongod&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--bind_ip&quot;, &quot;0.0.0.0&quot;]
    networks:
      - mongo-network

  setup:
    image: mongo:latest
    container_name: mongo-setup
    depends_on:
      - mongo1
      - mongo2
      - mongo3
      - mongo-arbiter
    entrypoint: [ &quot;bash&quot;, &quot;-c&quot;, &quot;sleep 10 &amp;&amp; mongosh --host mongo1:27017 /scripts/replica-init.js&quot; ]
    volumes:
      - ./scripts:/scripts
    networks:
      - mongo-network

networks:
  mongo-network:
    driver: bridge
volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
</div><p id="z8kqkkm_35"><span class="control" id="z8kqkkm_40">Nous avons ici 4 conteneurs</span></p><ul class="list _bullet" id="z8kqkkm_36"><li class="list__item" id="z8kqkkm_41"><p>Trois conteneurs de donn&eacute;es dont le premier sera le n&oelig;ud primaire.</p></li><li class="list__item" id="z8kqkkm_42"><p>Un conteneur d'arbitrage qui ne servira qu'&agrave; voter pour un nouveau n&oelig;ud primaire.</p></li><li class="list__item" id="z8kqkkm_43"><p>Un conteneur <code class="code" id="z8kqkkm_44">setup</code> qui lancera la configuration apr&egrave;s un d&eacute;lai pour laisser le temps aux autres conteneurs de s'instancier.</p></li></ul><section class="chapter"><h4 id="comment-a-marche" data-toc="comment-a-marche">Comment &ccedil;a marche</h4></section><section class="chapter"><h4 id="configuration-des-n-uds" data-toc="configuration-des-n-uds">Configuration des n&oelig;uds</h4><div class="code-block" data-lang="yaml">
command: [&quot;mongod&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--bind_ip&quot;, &quot;0.0.0.0&quot;]
</div><p id="z8kqkkm_46">Chaque conteneur lance le service MongDB avec les options suivantes :</p><ul class="list _bullet" id="z8kqkkm_47"><li class="list__item" id="z8kqkkm_48"><p><code class="code" id="z8kqkkm_51">--replSet</code> indique que ce conteneur fait partie d'un replica set.</p></li><li class="list__item" id="z8kqkkm_49"><p><code class="code" id="z8kqkkm_52">rs0</code>, il s'agit de l'identifiant du replica set.</p></li><li class="list__item" id="z8kqkkm_50"><p><code class="code" id="z8kqkkm_53">&quot;--bind_ip&quot;, &quot;0.0.0.0&quot;</code>, lie le conteneur &agrave; toute interface r&eacute;seau disponible. Cela permet aux conteneurs de communiquer entre eux.</p></li></ul></section><section class="chapter"><h4 id="initialisation" data-toc="initialisation">Initialisation</h4><p id="z8kqkkm_54">Le conteneur <code class="code" id="z8kqkkm_58">setup</code> d&eacute;clare un entrypoint avec la commande suivante :</p><div class="code-block" data-lang="yaml">
entrypoint: [ &quot;bash&quot;, &quot;-c&quot;, &quot;sleep 10 &amp;&amp; mongosh --host mongo1:27017 /scripts/replica-init.js&quot; ]
</div><ul class="list _bullet" id="z8kqkkm_56"><li class="list__item" id="z8kqkkm_59"><p><code class="code" id="z8kqkkm_63">bash</code>, le programme &agrave; lancer</p></li><li class="list__item" id="z8kqkkm_60"><p><code class="code" id="z8kqkkm_64">-c</code>, indique que la chaine de caract&egrave;re qui va suivre doit &ecirc;tre ex&eacute;cut&eacute;e comme une instruction. S'il y a plusieurs commandes dans cette cha&icirc;ne elles doivent &ecirc;tre s&eacute;par&eacute;es par <code class="code" id="z8kqkkm_65">&amp;&amp;</code>.</p></li><li class="list__item" id="z8kqkkm_61"><p><code class="code" id="z8kqkkm_66">sleep 10</code>, d&eacute;finit un d&eacute;lai avant l'ex&eacute;cution des commandes suivantes.</p></li><li class="list__item" id="z8kqkkm_62"><p><code class="code" id="z8kqkkm_67">mongosh --host mongo1:27017 /scripts/replica-init.js</code>, lance un shell MongoDB sur le premier n&oelig;ud et ex&eacute;cute un fichier javascript de configuration.</p></li></ul><div class="code-block" data-lang="javascript">
rs.initiate({
    _id: &quot;rs0&quot;,
    members: [
        { _id: 0, host: &quot;mongo1:27017&quot; },
        { _id: 1, host: &quot;mongo2:27017&quot; },
        { _id: 2, host: &quot;mongo3:27017&quot; },
        { _id: 3, host: &quot;mongo-arbiter:27017&quot;, arbiterOnly: true }
    ]
});
</div></section></section><section class="chapter"><h3 id="test" data-toc="test">Test</h3><section class="procedure-steps" id="z8kqkkm_68"><ol class="list _decimal"><li class="list__item" id="z8kqkkm_69"><p>Instancier toute la stack </p><div class="code-block" data-lang="bash">
docker compose up -d
</div></li><li class="list__item" id="z8kqkkm_70"><p>Lancer un terminal sur le n&oelig;ud primaire </p><div class="code-block" data-lang="bash">
docker exec -it mongo1
</div></li><li class="list__item" id="z8kqkkm_71"><p>V&eacute;rifier la configuration du replica set </p><div class="code-block" data-lang="mongodb">
rs.status()
</div></li><li class="list__item" id="z8kqkkm_72"><p>Effectuer une insertions </p><div class="code-block" data-lang="mongodb">
use test
</div><div class="code-block" data-lang="mongodb">
db.persons.insertOne({name: 'Ada Lovelace'}
</div></li><li class="list__item" id="z8kqkkm_73"><p>Sortir du shell Mongo </p><div class="code-block" data-lang="mongodb">
exit
</div></li><li class="list__item" id="z8kqkkm_74"><p>En ouvrir un autre sur le conteneur mongo2 </p><div class="code-block" data-lang="bash">
docker exec -it mongo2
</div></li><li class="list__item" id="z8kqkkm_75"><p>V&eacute;rifier que l'insertion a bien &eacute;t&eacute; r&eacute;pliqu&eacute;e </p><div class="code-block" data-lang="mongodb">
use test
</div><div class="code-block" data-lang="mongodb">
db.persons.find({})
</div></li></ol></section></section><section class="chapter"><h3 id="avantages-de-cette-technique" data-toc="avantages-de-cette-technique">Avantages de cette technique</h3><ul class="list _bullet" id="z8kqkkm_85"><li class="list__item" id="z8kqkkm_86"><p><span class="control" id="z8kqkkm_89">Haute disponibilit&eacute;</span>: Si un serveur tombe, un autre prend le relais.</p></li><li class="list__item" id="z8kqkkm_87"><p><span class="control" id="z8kqkkm_90">Protection contre la perte de donn&eacute;es</span>: La r&eacute;plication garantit la redondance.</p></li><li class="list__item" id="z8kqkkm_88"><p><span class="control" id="z8kqkkm_91">Scalabilit&eacute; en lecture</span>: On peut lire depuis les secondaires pour all&eacute;ger la charge.</p></li></ul></section></section><section class="chapter"><h2 id="sharding" data-toc="sharding">Sharding</h2><p id="z8kqkkm_92">Technique de partitionnement horizontal des donn&eacute;es, permettant de distribuer la charge entre plusieurs serveurs afin d'am&eacute;liorer les performances et la scalabilit&eacute; d'une base de donn&eacute;es volumineuse.</p><section class="chapter"><h3 id="pourquoi" data-toc="pourquoi">Pourquoi</h3><ul class="list _bullet" id="z8kqkkm_96"><li class="list__item" id="z8kqkkm_97"><p><span class="control" id="z8kqkkm_100">Scalabilit&eacute; horizontale</span>&nbsp;: Permet d'ajouter des n&oelig;uds pour r&eacute;partir la charge.</p></li><li class="list__item" id="z8kqkkm_98"><p><span class="control" id="z8kqkkm_101">Gestion efficace des grosses bases de donn&eacute;es</span>&nbsp;: Divise les collections en morceaux (chunks) r&eacute;partis sur plusieurs shards.</p></li><li class="list__item" id="z8kqkkm_99"><p><span class="control" id="z8kqkkm_102">Disponibilit&eacute; et tol&eacute;rance aux pannes</span>&nbsp;: Chaque shard peut &ecirc;tre r&eacute;pliqu&eacute; pour garantir la haute disponibilit&eacute;.</p></li></ul></section><section class="chapter"><h3 id="comment" data-toc="comment">Comment</h3><p id="z8kqkkm_103">Un cluster &quot;sharded&quot; est compos&eacute; des serveurs suivants :</p><ul class="list _bullet" id="z8kqkkm_104"><li class="list__item" id="z8kqkkm_106"><p><span class="control" id="z8kqkkm_109">Shards</span>&nbsp;: Stockent les donn&eacute;es r&eacute;elles et peuvent &ecirc;tre des Replica Sets pour assurer la haute disponibilit&eacute;.</p></li><li class="list__item" id="z8kqkkm_107"><p><span class="control" id="z8kqkkm_110">Config Servers</span>&nbsp;: Stockent la configuration du cluster et les m&eacute;tadonn&eacute;es des chunks.</p></li><li class="list__item" id="z8kqkkm_108"><p><span class="control" id="z8kqkkm_111">Query Routers (mongos)</span>&nbsp;: Servent d'interface entre l'application et le cluster, dirigeant les requ&ecirc;tes vers les bons shards.</p></li></ul><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="492px" preserveAspectRatio="none" style="width:1529px;height:492px;background:#FFFFFF;" version="1.1" viewBox="0 0 1529 492" width="1529px" zoomAndPan="magnify"><defs/><g><!--cluster MongoDB Cluster--><g id="cluster_MongoDB Cluster"><polygon fill="none" points="16,78.49,26,68.49,1512,68.49,1512,465.95,1502,475.95,16,475.95,16,78.49" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1502" x2="1512" y1="78.49" y2="68.49"/><line style="stroke:#181818;stroke-width:1.0;" x1="16" x2="1502" y1="78.49" y2="78.49"/><line style="stroke:#181818;stroke-width:1.0;" x1="1502" x2="1502" y1="78.49" y2="475.95"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="126" x="697" y="95.0252">MongoDB Cluster</text></g><!--cluster Query Router--><g id="cluster_Query Router"><polygon fill="none" points="348,126.49,358,116.49,634,116.49,634,208.97,624,218.97,348,218.97,348,126.49" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="624" x2="634" y1="126.49" y2="116.49"/><line style="stroke:#181818;stroke-width:1.0;" x1="348" x2="624" y1="126.49" y2="126.49"/><line style="stroke:#181818;stroke-width:1.0;" x1="624" x2="624" y1="126.49" y2="218.97"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="96" x="439" y="143.0252">Query Router</text></g><!--cluster Config Servers (configReplSet)--><g id="cluster_Config Servers (configReplSet)"><polygon fill="none" points="40,252.97,50,242.97,580,242.97,580,335.46,570,345.46,40,345.46,40,252.97" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="570" x2="580" y1="252.97" y2="242.97"/><line style="stroke:#181818;stroke-width:1.0;" x1="40" x2="570" y1="252.97" y2="252.97"/><line style="stroke:#181818;stroke-width:1.0;" x1="570" x2="570" y1="252.97" y2="345.46"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="219" x="196.5" y="269.5052">Config Servers (configReplSet)</text></g><!--cluster Shard 1 (shard1ReplSet)--><g id="cluster_Shard 1 (shard1ReplSet)"><polygon fill="none" points="604,252.97,614,242.97,1034,242.97,1034,441.95,1024,451.95,604,451.95,604,252.97" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1024" x2="1034" y1="252.97" y2="242.97"/><line style="stroke:#181818;stroke-width:1.0;" x1="604" x2="1024" y1="252.97" y2="252.97"/><line style="stroke:#181818;stroke-width:1.0;" x1="1024" x2="1024" y1="252.97" y2="451.95"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="172" x="729" y="269.5052">Shard 1 (shard1ReplSet)</text></g><!--cluster Shard 2 (shard2ReplSet)--><g id="cluster_Shard 2 (shard2ReplSet)"><polygon fill="none" points="1058,252.97,1068,242.97,1488,242.97,1488,441.95,1478,451.95,1058,451.95,1058,252.97" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1478" x2="1488" y1="252.97" y2="242.97"/><line style="stroke:#181818;stroke-width:1.0;" x1="1058" x2="1478" y1="252.97" y2="252.97"/><line style="stroke:#181818;stroke-width:1.0;" x1="1478" x2="1478" y1="252.97" y2="451.95"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="172" x="1183" y="269.5052">Shard 2 (shard2ReplSet)</text></g><!--entity client--><g id="elem_client"><polygon fill="#F1F1F1" points="410,16,420,6,572,6,572,42.4883,562,52.4883,410,52.4883,410,16" style="stroke:#181818;stroke-width:0.5;"/><line style="stroke:#181818;stroke-width:0.5;" x1="562" x2="572" y1="16" y2="6"/><line style="stroke:#181818;stroke-width:0.5;" x1="410" x2="562" y1="16" y2="16"/><line style="stroke:#181818;stroke-width:0.5;" x1="562" x2="562" y1="16" y2="52.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="425" y="39.5352">Client Application</text></g><!--entity Mongo Query Router (mongos)--><g id="elem_Mongo Query Router (mongos)"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="253" x="364.5" y="156.49"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="597.5" y="161.49"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="595.5" y="163.49"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="595.5" y="167.49"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="213" x="379.5" y="190.0252">Mongo Query Router (mongos)</text></g><!--entity Config Server 1--><g id="elem_Config Server 1"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="56" y="282.97"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="182" y="287.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="180" y="289.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="180" y="293.97"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="71" y="316.5052">Config Server 1</text></g><!--entity Config Server 2--><g id="elem_Config Server 2"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="237" y="282.97"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="363" y="287.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="361" y="289.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="361" y="293.97"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="252" y="316.5052">Config Server 2</text></g><!--entity Config Server 3--><g id="elem_Config Server 3"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="418" y="282.97"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="544" y="287.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="542" y="289.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="542" y="293.97"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="433" y="316.5052">Config Server 3</text></g><!--entity Shard1-1 Primary--><g id="elem_Shard1-1 Primary"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="162" x="630" y="282.97"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="772" y="287.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="770" y="289.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="770" y="293.97"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="645" y="316.5052">Shard1-1 Primary</text></g><!--entity Shard1-2 Secondary--><g id="elem_Shard1-2 Secondary"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="181" x="620.5" y="389.46"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="781.5" y="394.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="779.5" y="396.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="779.5" y="400.46"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="635.5" y="422.9952">Shard1-2 Secondary</text></g><!--entity Shard1-3 Secondary--><g id="elem_Shard1-3 Secondary"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="181" x="836.5" y="389.46"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="997.5" y="394.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="995.5" y="396.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="995.5" y="400.46"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="851.5" y="422.9952">Shard1-3 Secondary</text></g><!--entity Shard2-1 Primary--><g id="elem_Shard2-1 Primary"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="162" x="1084" y="282.97"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="1226" y="287.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1224" y="289.97"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1224" y="293.97"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="1099" y="316.5052">Shard2-1 Primary</text></g><!--entity Shard2-2 Secondary--><g id="elem_Shard2-2 Secondary"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="181" x="1074.5" y="389.46"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="1235.5" y="394.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1233.5" y="396.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1233.5" y="400.46"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="1089.5" y="422.9952">Shard2-2 Secondary</text></g><!--entity Shard2-3 Secondary--><g id="elem_Shard2-3 Secondary"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="181" x="1290.5" y="389.46"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="1451.5" y="394.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1449.5" y="396.46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1449.5" y="400.46"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="1305.5" y="422.9952">Shard2-3 Secondary</text></g><!--link client to Mongo Query Router (mongos)--><g id="link_client_Mongo Query Router (mongos)"><path d="M491,52.79 C491,80.86 491,122.51 491,150.45 " fill="none" id="client-to-Mongo Query Router (mongos)" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="491,156.45,495,147.45,491,151.45,487,147.45,491,156.45" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Mongo Query Router (mongos) to Config Server 1--><g id="link_Mongo Query Router (mongos)_Config Server 1"><path d="M364.32,193.49 C317.18,201.43 264.2,214.26 219,234.97 C193.59,246.62 173.2822,262.674 156.2022,278.414 " fill="none" id="Mongo Query Router (mongos)-to-Config Server 1" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="151.79,282.48,161.119,279.3224,155.4668,279.0916,155.6976,273.4395,151.79,282.48" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Mongo Query Router (mongos) to Config Server 2--><g id="link_Mongo Query Router (mongos)_Config Server 2"><path d="M450.46,203.43 C434.46,212.77 416.09,223.96 400,234.97 C378.08,249.97 359.1066,264.7363 341.5566,278.9963 " fill="none" id="Mongo Query Router (mongos)-to-Config Server 2" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="336.9,282.78,346.4073,280.2089,340.7805,279.627,341.3625,274.0001,336.9,282.78" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Mongo Query Router (mongos) to Config Server 3--><g id="link_Mongo Query Router (mongos)_Config Server 3"><path d="M491,203.27 C491,225.83 491,254.34 491,276.84 " fill="none" id="Mongo Query Router (mongos)-to-Config Server 3" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="491,282.84,495,273.84,491,277.84,487,273.84,491,282.84" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Mongo Query Router (mongos) to Shard1-1 Primary--><g id="link_Mongo Query Router (mongos)_Shard1-1 Primary"><path d="M531.1,203.42 C570.76,225.86 625.8981,257.055 665.5881,279.515 " fill="none" id="Mongo Query Router (mongos)-to-Shard1-1 Primary" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="670.81,282.47,664.9472,274.5563,666.4584,280.0075,661.0072,281.5188,670.81,282.47" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Mongo Query Router (mongos) to Shard2-1 Primary--><g id="link_Mongo Query Router (mongos)_Shard2-1 Primary"><path d="M617.87,187.66 C753.42,196.09 958.9,212.08 1034,234.97 C1069.3,245.73 1100.9673,263.1856 1126.5173,279.3256 " fill="none" id="Mongo Query Router (mongos)-to-Shard2-1 Primary" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1131.59,282.53,1126.1173,274.3416,1127.3628,279.8597,1121.8448,281.1052,1131.59,282.53" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Shard1-1 Primary to Shard1-2 Secondary--><g id="link_Shard1-1 Primary_Shard1-2 Secondary"><path d="M711,329.89 C711,347.42 711,365.56 711,383.08 " fill="none" id="Shard1-1 Primary-to-Shard1-2 Secondary" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="711,389.08,715,380.08,711,384.08,707,380.08,711,389.08" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Shard1-1 Primary to Shard1-3 Secondary--><g id="link_Shard1-1 Primary_Shard1-3 Secondary"><path d="M757.87,329.89 C794.1,347.42 838.6193,368.9462 874.8193,386.4662 " fill="none" id="Shard1-1 Primary-to-Shard1-3 Secondary" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="880.22,389.08,873.8615,381.5588,875.7194,386.9018,870.3764,388.7597,880.22,389.08" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Shard2-1 Primary to Shard2-2 Secondary--><g id="link_Shard2-1 Primary_Shard2-2 Secondary"><path d="M1165,329.89 C1165,347.42 1165,365.56 1165,383.08 " fill="none" id="Shard2-1 Primary-to-Shard2-2 Secondary" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1165,389.08,1169,380.08,1165,384.08,1161,380.08,1165,389.08" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Shard2-1 Primary to Shard2-3 Secondary--><g id="link_Shard2-1 Primary_Shard2-3 Secondary"><path d="M1211.87,329.89 C1248.1,347.42 1292.6193,368.9462 1328.8193,386.4662 " fill="none" id="Shard2-1 Primary-to-Shard2-3 Secondary" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1334.22,389.08,1327.8615,381.5588,1329.7194,386.9018,1324.3764,388.7597,1334.22,389.08" style="stroke:#181818;stroke-width:1.0;"/></g><!--SRC=[dLAzReCm6Dpz52UMa841irTgoLgf3MF4WC19BHc3RAWQLJmGpy6BrVn8ZGCaQJrXtyztvhp1hckFNFAA5n8Pq-XQqRKvavKciiWOd51miyDpMGgU9ZtFGQAHZiVV16QHPYA_5l9Kx5uGYbfNJ3a67mWZ-bupTSQ-g2S8qpeCCbp2SFF-J6_ZWTMCOtwjma8U-GaHKvzCQRZfiD-pKaIisbhc5XL-Z3M8haF113MNrua-4fN1Xwlx3tzn-C3nFHzlYkU9EiSpY9eP9dss20RNu480EWMWwm7eUW1wAm1T2c0Y7CRsOtYPztIdlWtChvJiopmS3IDI3C9-PpVryFe9rnt-NKF_eGbYyeXetl6Z8giNCZUo_AsUxd2jsiXyc9LXmNYLQnd_0000]--></g></svg></div></section><section class="chapter"><h3 id="exemple-de-d-ploiement-avec-docker" data-toc="exemple-de-d-ploiement-avec-docker">Exemple de d&eacute;ploiement avec Docker</h3><ul class="list _bullet" id="z8kqkkm_112"><li class="list__item" id="z8kqkkm_117"><p>2 shards (r&eacute;pliqu&eacute;s)</p></li><li class="list__item" id="z8kqkkm_118"><p>3 config servers</p></li><li class="list__item" id="z8kqkkm_119"><p>1 routeur (mongos)</p></li></ul><div class="code-block" data-lang="yaml">
version: '3.8'

services:
   # Config Servers (stockent la config du cluster)
   configsvr1:
      image: mongo:6.0
      container_name: configsvr1
      command: mongod --configsvr --replSet configReplSet --port 27017
      ports:
         - 27017:27017
      networks:
         - mongo-cluster

   configsvr2:
      image: mongo:6.0
      container_name: configsvr2
      command: mongod --configsvr --replSet configReplSet --port 27017
      networks:
         - mongo-cluster

   configsvr3:
      image: mongo:6.0
      container_name: configsvr3
      command: mongod --configsvr --replSet configReplSet --port 27017
      networks:
         - mongo-cluster

   # Shard 1 - Replica Set
   shard1-1:
      image: mongo:6.0
      container_name: shard1-1
      command: mongod --shardsvr --replSet shard1ReplSet --port 27017
      networks:
         - mongo-cluster

   shard1-2:
      image: mongo:6.0
      container_name: shard1-2
      command: mongod --shardsvr --replSet shard1ReplSet --port 27017
      networks:
         - mongo-cluster

   shard1-3:
      image: mongo:6.0
      container_name: shard1-3
      command: mongod --shardsvr --replSet shard1ReplSet --port 27017
      networks:
         - mongo-cluster

   # Shard 2 - Replica Set
   shard2-1:
      image: mongo:6.0
      container_name: shard2-1
      command: mongod --shardsvr --replSet shard2ReplSet --port 27017
      networks:
         - mongo-cluster

   shard2-2:
      image: mongo:6.0
      container_name: shard2-2
      command: mongod --shardsvr --replSet shard2ReplSet --port 27017
      networks:
         - mongo-cluster

   shard2-3:
      image: mongo:6.0
      container_name: shard2-3
      command: mongod --shardsvr --replSet shard2ReplSet --port 27017
      networks:
         - mongo-cluster

   # Query Router (mongos)
   mongos:
      image: mongo:6.0
      container_name: mongos
      command: mongos --configdb configReplSet/configsvr1:27017,configsvr2:27017,configsvr3:27017 --port 27017
      ports:
         - 27020:27017
      networks:
         - mongo-cluster
      depends_on:
         - configsvr1
         - configsvr2
         - configsvr3
         - shard1-1
         - shard1-2
         - shard1-3
         - shard2-1
         - shard2-2
         - shard2-3

networks:
   mongo-cluster:
      driver: bridge

</div><section class="chapter"><h4 id="configuration-du-cluster" data-toc="configuration-du-cluster">Configuration du cluster</h4><p id="z8kqkkm_120">Pour la configuration, nous cr&eacute;ons un fichier bash</p><div class="code-block" data-lang="bash">
#!/bin/bash

## setup-sharding.sh

echo &quot;â³ Initialisation du cluster MongoDB shardÃ©...&quot;

# Initialiser le Replica Set des Config Servers
echo &quot;ð Configuration des Config Servers...&quot;
docker exec -it configsvr1 mongosh --eval '
rs.initiate({
  _id: &quot;configReplSet&quot;,
  configsvr: true,
  members: [
    { _id: 0, host: &quot;configsvr1:27017&quot; },
    { _id: 1, host: &quot;configsvr2:27017&quot; },
    { _id: 2, host: &quot;configsvr3:27017&quot; }
  ]
});
'

# Attendre quelques secondes pour l'initialisation
sleep 5

# Initialiser le Replica Set du Shard 1
echo &quot;ð Configuration du Shard 1...&quot;
docker exec -it shard1-1 mongosh --eval '
rs.initiate({
  _id: &quot;shard1ReplSet&quot;,
  members: [
    { _id: 0, host: &quot;shard1-1:27017&quot; },
    { _id: 1, host: &quot;shard1-2:27017&quot; },
    { _id: 2, host: &quot;shard1-3:27017&quot; }
  ]
});
'

# Attendre quelques secondes pour l'initialisation
sleep 5

# Initialiser le Replica Set du Shard 2
echo &quot;ð Configuration du Shard 2...&quot;
docker exec -it shard2-1 mongosh --eval '
rs.initiate({
  _id: &quot;shard2ReplSet&quot;,
  members: [
    { _id: 0, host: &quot;shard2-1:27017&quot; },
    { _id: 1, host: &quot;shard2-2:27017&quot; },
    { _id: 2, host: &quot;shard2-3:27017&quot; }
  ]
});
'

# Attendre quelques secondes pour l'initialisation
sleep 5

# Ajouter les Shards au Query Router (mongos)
echo &quot;ð Ajout des shards au routeur...&quot;
docker exec -it mongos mongosh --eval '
sh.addShard(&quot;shard1ReplSet/shard1-1:27017&quot;);
sh.addShard(&quot;shard2ReplSet/shard2-1:27017&quot;);
'

# Activer le sharding sur la base de donnÃ©es `mydatabase`
echo &quot;â Activation du sharding sur la base de donnÃ©es mydatabase...&quot;
docker exec -it mongos mongosh --eval '
sh.enableSharding(&quot;mydatabase&quot;);
'

# VÃ©rifier l'Ã©tat du cluster
echo &quot;ð Ãtat du cluster :&quot;
docker exec -it mongos mongosh --eval 'sh.status();'

echo &quot;ð Cluster MongoDB sharded configurÃ© avec succÃ¨s !&quot;

</div><p id="z8kqkkm_122">Pour rendre le fichier ex&eacute;cutable</p><div class="code-block" data-lang="bash">
chmod +x setup-sharding.sh
</div><p id="z8kqkkm_124">Pour lancer le script</p><div class="code-block" data-lang="bash">
./setup-sharding.sh
</div></section><section class="chapter"><h4 id="pourquoi-trois-config-servers" data-toc="pourquoi-trois-config-servers">Pourquoi trois config servers ?</h4><p id="z8kqkkm_126">Un Config Server dans MongoDB stocke les m&eacute;tadonn&eacute;es du sharding (comme la r&eacute;partition des chunks entre les shards). Il est essentiel au bon fonctionnement du cluster.</p><p id="z8kqkkm_127">MongoDB exige au moins trois Config Servers pour garantir :</p><ul class="list _bullet" id="z8kqkkm_128"><li class="list__item" id="z8kqkkm_138"><p><span class="control" id="z8kqkkm_139">La haute disponibilit&eacute; :</span></p></li></ul><p id="z8kqkkm_129">Si un seul Config Server tombe en panne, le cluster continue &agrave; fonctionner. Avec un seul Config Server, une panne entra&icirc;nerait une perte de donn&eacute;es de sharding.</p><ul class="list _bullet" id="z8kqkkm_130"><li class="list__item" id="z8kqkkm_140"><p><span class="control" id="z8kqkkm_141">La tol&eacute;rance aux pannes :</span></p></li></ul><p id="z8kqkkm_131">MongoDB utilise un Replica Set pour les Config Servers. Avec 3 membres, m&ecirc;me si un serveur tombe, les deux autres peuvent continuer &agrave; fonctionner.</p><ul class="list _bullet" id="z8kqkkm_132"><li class="list__item" id="z8kqkkm_142"><p><span class="control" id="z8kqkkm_143">La s&eacute;curit&eacute; des m&eacute;tadonn&eacute;es :</span></p></li></ul><p id="z8kqkkm_133">Le sharding repose sur ces m&eacute;tadonn&eacute;es. Si elles sont corrompues ou perdues, le cluster devient instable.</p><p id="z8kqkkm_134">Trois Config Servers assurent une r&eacute;plication et une coh&eacute;rence des informations.</p><ul class="list _bullet" id="z8kqkkm_135"><li class="list__item" id="z8kqkkm_144"><p><span class="control" id="z8kqkkm_145">&Eacute;viter les partitions r&eacute;seau :</span></p></li></ul><p id="z8kqkkm_136">Si un seul Config Server est utilis&eacute; et qu&rsquo;il devient injoignable, le mongos (Query Router) ne peut plus router les requ&ecirc;tes.</p><p id="z8kqkkm_137">Avec trois Config Servers, un quorum est toujours maintenu.</p></section><section class="chapter"><h4 id="r-gles-importantes-pour-les-config-servers" data-toc="r-gles-importantes-pour-les-config-servers">R&egrave;gles importantes pour les Config Servers</h4><ul class="list _bullet" id="z8kqkkm_146"><li class="list__item" id="z8kqkkm_147"><p>Toujours avoir un nombre impair de Config Servers (ex : 3, 5, 7...) pour &eacute;viter les conflits de quorum.</p></li><li class="list__item" id="z8kqkkm_148"><p>Ne pas stocker des donn&eacute;es utilisateur sur les Config Servers (ils sont uniquement destin&eacute;s aux m&eacute;tadonn&eacute;es).</p></li><li class="list__item" id="z8kqkkm_149"><p>Tous les Config Servers doivent &ecirc;tre en Replica Set (obligatoire depuis MongoDB 3.4).</p></li></ul></section></section></section><div class="last-modified">Last modified: 23 fÃ©vrier 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="006-00-optimisation.html" class="navigation-links__prev">Optimisation</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.js"></script></body></html>